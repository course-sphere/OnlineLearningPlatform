@using Domain.Responses.Course
@using Domain.Responses.Module
@using Domain.Responses.Lesson

@model Domain.Responses.Course.CourseDetailResponse

@{
    ViewData["Title"] = "Edit Course";

    var options = new System.Text.Json.JsonSerializerOptions
    {
        PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
    };

    // Cast rõ ràng namespace để tránh lỗi Ambiguous (CS0104)
    var modulesList = ViewBag.Modules as List<Domain.Responses.Module.ModuleResponse> ?? new List<Domain.Responses.Module.ModuleResponse>();

    var modulesJson = System.Text.Json.JsonSerializer.Serialize(modulesList, options);
}

<div class="min-h-screen bg-slate-50 pb-20"
     x-data="courseEditor('@Model.CourseId', @Html.Raw(modulesJson))">

    <div class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-4">
                    <a asp-action="Index" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="flex items-center gap-3">
                        <h1 class="text-xl font-bold text-slate-900 truncate max-w-md">@Model.Title</h1>
                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">Draft</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <form asp-action="SubmitForReview" method="post">
                        <input type="hidden" name="id" value="@Model.CourseId" />
                        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 shadow-sm transition-all flex items-center gap-2">
                            <i class="fas fa-paper-plane"></i> Submit
                        </button>
                    </form>
                </div>
            </div>

            <div class="flex gap-8 -mb-px">
                <button @@click="activeTab = 'curriculum'"
                        :class="activeTab === 'curriculum' ? 'border-primary-600 text-primary-600 border-b-2' : 'border-transparent text-slate-500 hover:text-slate-700 border-b-2'"
                        class="pb-4 font-medium text-sm transition-colors">
                    Curriculum
                </button>
                <button @@click="activeTab = 'settings'"
                        :class="activeTab === 'settings' ? 'border-primary-600 text-primary-600 border-b-2' : 'border-transparent text-slate-500 hover:text-slate-700 border-b-2'"
                        class="pb-4 font-medium text-sm transition-colors">
                    Settings
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto py-8 px-4">

        <div x-show="activeTab === 'curriculum'" class="space-y-6" x-transition.opacity>
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-slate-900">Course Content</h2>
                <button @@click="openModuleModal()" class="px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800 shadow-sm flex items-center gap-2">
                    <i class="fas fa-plus"></i> New Module
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(module, mIndex) in modules" :key="module.moduleId">
                    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm mb-4" x-data="{ open: true }">
                        <div class="p-4 bg-slate-50 flex items-center justify-between cursor-pointer hover:bg-slate-100 transition-colors" @@click="open = !open">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-grip-vertical text-slate-400 cursor-move"></i>
                                <div>
                                    <span class="font-bold text-slate-800" x-text="`Module ${mIndex + 1}:`"></span>
                                    <span class="text-slate-700" x-text="module.name"></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="text-slate-400 hover:text-red-600" @@click.stop="deleteModule(module.moduleId)">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
                            </div>
                        </div>

                        <div x-show="open" class="border-t border-slate-200 bg-white p-4 space-y-2">
                            <template x-for="(lesson, lIndex) in module.lessons" :key="lesson.lessonId">
                                <div class="pl-4 py-3 flex items-center justify-between group border border-slate-100 rounded-lg hover:border-primary-200 hover:bg-blue-50 transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                                             :class="[2,3].includes(lesson.type) ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'">
                                            <i class="fas" :class="[2,3].includes(lesson.type) ? 'fa-clipboard-question' : 'fa-play-circle'"></i>
                                        </div>
                                        <span class="text-sm font-medium text-slate-700" x-text="lesson.title"></span>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <template x-if="[0, 1].includes(lesson.type)">
                                            <button @@click="openResourceModal(lesson)" class="text-xs px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-slate-600 shadow-sm flex items-center gap-1">
                                                <i class="fas fa-paperclip"></i> Content
                                            </button>
                                        </template>

                                        <template x-if="[2, 3].includes(lesson.type)">
                                            <a :href="lesson.gradedItems && lesson.gradedItems.length > 0 ? `/Instructor/EditQuiz/${lesson.gradedItems[0].gradedItemId}` : '#'"
                                               class="text-xs px-3 py-1 bg-white border border-purple-200 text-purple-700 rounded hover:bg-purple-50 shadow-sm flex items-center gap-1"
                                               @@click="if(!lesson.gradedItems || lesson.gradedItems.length === 0) {
                                                   window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Data missing. Please delete and recreate this quiz.', type: 'error' } }));
                                                   $event.preventDefault();
                                               }">
                                                <i class="fas fa-tasks"></i> Edit Quiz
                                            </a>
                                        </template>

                                        <button class="text-xs px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50 text-slate-600 shadow-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>

                            <div x-show="!module.lessons || module.lessons.length === 0" class="text-sm text-slate-400 italic pl-4">
                                No lessons yet.
                            </div>

                            <div class="pt-2">
                                <button @@click.stop="openLessonModal(module.moduleId)" class="text-sm text-primary-600 font-medium hover:text-primary-700 flex items-center justify-center gap-2 w-full py-2 border border-dashed border-primary-200 rounded-lg hover:bg-primary-50 transition-colors">
                                    <i class="fas fa-plus-circle"></i> Add Lesson
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="modules.length === 0" class="text-center py-12 border-2 border-dashed border-slate-300 rounded-xl">
                    <p class="text-slate-500">No modules found. Create one to start!</p>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'settings'" x-transition.opacity>
            <div class="bg-white p-8 rounded-xl border border-slate-200 text-center text-slate-500">
                <p>Course Settings (Coming Soon)</p>
            </div>
        </div>
    </div>

    <div x-show="showModuleModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" @@click.away="showModuleModal = false">
            <h3 class="text-lg font-bold text-slate-900 mb-4">Add New Module</h3>
            <div class="space-y-4">
                <input type="text" x-model="newModule.name" class="w-full rounded-lg border-slate-300" placeholder="Module Name">
                <textarea x-model="newModule.description" class="w-full rounded-lg border-slate-300" rows="2" placeholder="Description"></textarea>
                <div class="flex justify-end gap-3">
                    <button @@click="showModuleModal = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">Cancel</button>
                    <button @@click="createModule()" class="px-4 py-2 bg-slate-900 text-white rounded-lg text-sm" :disabled="isProcessing">
                        <span x-show="!isProcessing">Create</span>
                        <span x-show="isProcessing">Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showLessonModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" @@click.away="showLessonModal = false">
            <h3 class="text-lg font-bold text-slate-900 mb-4">Add New Lesson</h3>
            <div class="space-y-4">
                <input type="text" x-model="newLesson.title" class="w-full rounded-lg border-slate-300" placeholder="Lesson Title">

                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Type</label>
                    <select x-model.number="newLesson.type" class="w-full rounded-lg border-slate-300 text-sm">
                        <option value="0">Video Lesson</option>
                        <option value="1">Reading / Article</option>
                        <option value="2">Practice Quiz</option>
                        <option value="3">Graded Assignment</option>
                    </select>
                </div>

                <textarea x-model="newLesson.content" class="w-full rounded-lg border-slate-300" rows="3" placeholder="Description / Content"></textarea>

                <div class="flex justify-end gap-3">
                    <button @@click="showLessonModal = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">Cancel</button>
                    <button @@click="createLesson()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm" :disabled="isProcessing">
                        <span x-show="!isProcessing">Create</span>
                        <span x-show="isProcessing">Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showResourceModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6" @@click.away="showResourceModal = false">
            <h3 class="text-lg font-bold text-slate-900 mb-1">Manage Content</h3>
            <p class="text-sm text-slate-500 mb-4" x-text="`For lesson: ${currentLesson?.title}`"></p>

            <div class="bg-slate-50 rounded-lg p-4 mb-6 border border-slate-200 max-h-60 overflow-y-auto">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Current Resources</h4>

                <div x-show="isLoadingResources" class="text-center py-4 text-slate-400">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Loading resources...
                </div>

                <div x-show="!isLoadingResources && resources.length === 0" class="text-sm text-slate-400 italic text-center">
                    No resources uploaded yet.
                </div>

                <ul x-show="!isLoadingResources && resources.length > 0" class="space-y-2">
                    <template x-for="res in resources" :key="res.lessonResourceId">
                        <li class="flex items-center justify-between bg-white p-2 rounded border border-slate-100 text-sm hover:shadow-sm">
                            <div class="flex items-center gap-3 truncate">
                                <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-slate-500">
                                    <i class="fas" :class="{
                                        'fa-video text-red-500': res.resourceType === 0,
                                        'fa-file-pdf text-red-600': res.resourceType === 1,
                                        'fa-link text-blue-500': res.resourceType === 4,
                                        'fa-file': ![0,1,4].includes(res.resourceType)
                                    }"></i>
                                </div>
                                <a :href="res.resourceUrl" target="_blank" class="text-slate-700 hover:text-blue-600 font-medium truncate max-w-[200px]" x-text="res.title"></a>
                            </div>
                            <button @@click="deleteResource(res.lessonResourceId)" class="text-slate-400 hover:text-red-500 p-1 rounded hover:bg-red-50 transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </li>
                    </template>
                </ul>
            </div>

            <div class="space-y-4 pt-4 border-t border-slate-100">
                <h4 class="text-sm font-bold text-slate-900">Upload New Resource</h4>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Title</label>
                    <input type="text" x-model="newResource.title" class="w-full rounded-lg border-slate-300 text-sm" placeholder="e.g. Slide PDF, Video Demo">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">File</label>
                    <input type="file" @@change="newResource.file = $event.target.files[0]" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
                </div>

                <div x-show="isUploading" class="w-full bg-slate-200 rounded-full h-2.5 mt-2">
                    <div class="bg-primary-600 h-2.5 rounded-full transition-all duration-300" style="width: 100%"></div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button @@click="showResourceModal = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">Close</button>
                    <button @@click="uploadResource()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm flex items-center gap-2" :disabled="isUploading">
                        <span x-show="!isUploading">Upload</span>
                        <span x-show="isUploading"><i class="fas fa-spinner fa-spin"></i> Uploading...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function courseEditor(courseId, initialModules) {
        return {
            activeTab: 'curriculum',
            modules: initialModules || [],
            showModuleModal: false,
            showLessonModal: false,
            showResourceModal: false,
            isProcessing: false,
            isUploading: false,
            isLoadingResources: false,
            newModule: { name: '', description: '', index: 0 },
            newLesson: { title: '', content: '', moduleId: null, type: 0 },
            currentLesson: null,
            newResource: { title: '', file: null },
            resources: [],

            openModuleModal() {
                this.newModule = { name: '', description: '', index: this.modules.length + 1 };
                this.showModuleModal = true;
            },
            async createModule() {
                if (!this.newModule.name) {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Module Name is required!', type: 'error' } }));
                    return;
                }
                this.isProcessing = true;
                try {
                    const payload = { courseId, ...this.newModule };
                    const res = await fetch('/Instructor/CreateModule', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (res.ok) {
                        this.modules.push({ ...data.result, lessons: [] });
                        this.showModuleModal = false;
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Module created successfully!', type: 'success' } }));
                    } else {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: data.message || 'Error creating module', type: 'error' } }));
                    }
                } catch (e) { console.error(e); }
                finally { this.isProcessing = false; }
            },
            deleteModule(id) {
                if (!confirm('Delete this module?')) return;
                this.modules = this.modules.filter(m => m.moduleId !== id);
                window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Module deleted (Simulation)', type: 'success' } }));
            },
            openLessonModal(moduleId) {
                this.newLesson = { title: '', content: '', moduleId: moduleId, type: 0 };
                this.showLessonModal = true;
            },
            async createLesson() {
                if (!this.newLesson.title) {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Lesson Title is required!', type: 'error' } }));
                    return;
                }
                this.isProcessing = true;
                try {
                    const res = await fetch('/Instructor/CreateLesson', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.newLesson)
                    });
                    const data = await res.json();
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: data.message || 'Error creating lesson', type: 'error' } }));
                        this.isProcessing = false;
                    }
                } catch (e) {
                    console.error(e);
                    this.isProcessing = false;
                }
            },
            openResourceModal(lesson) {
                this.currentLesson = lesson;
                this.newResource = { title: '', file: null };
                this.resources = [];
                this.showResourceModal = true;
                this.fetchResources(lesson.lessonId);
            },
            async fetchResources(lessonId) {
                this.isLoadingResources = true;
                try {
                    const res = await fetch(`/Instructor/GetLessonResources?lessonId=${lessonId}`);
                    if (res.ok) {
                        const data = await res.json();
                        this.resources = data.result || [];
                    }
                } catch (e) { console.error(e); }
                finally { this.isLoadingResources = false; }
            },
            async uploadResource() {
                if (!this.newResource.title || !this.newResource.file) {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Please provide both Title and File', type: 'error' } }));
                    return;
                }
                this.isUploading = true;
                const formData = new FormData();
                formData.append('LessonId', this.currentLesson.lessonId);
                formData.append('Title', this.newResource.title);
                formData.append('File', this.newResource.file);
                try {
                    const res = await fetch('/Instructor/UploadResource', {
                        method: 'POST', body: formData
                    });
                    const data = await res.json();
                    if (res.ok) {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Upload successful!', type: 'success' } }));
                        this.fetchResources(this.currentLesson.lessonId);
                        this.newResource = { title: '', file: null };
                    } else {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'Upload failed: ' + (data.message || 'Unknown error'), type: 'error' } }));
                    }
                } catch (e) {
                    console.error(e);
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'System error during upload', type: 'error' } }));
                }
                finally { this.isUploading = false; }
            },
            async deleteResource(id) {
                if (!confirm('Delete this file?')) return;
                this.resources = this.resources.filter(r => r.lessonResourceId !== id);
                window.dispatchEvent(new CustomEvent('notify', { detail: { message: 'File deleted', type: 'success' } }));
            }
        }
    }
</script>