@using Domain.Responses.Course
@using System.Text.Json
@model List<CourseResponse>

    @{
    ViewData["Title"] = "All Courses";

    // 1. Chuyển đổi dữ liệu C# sang định dạng JSON mà UI cần
    // Map các trường C# (PascalCase) sang JS (camelCase)
    var coursesData = Model.Select(c => new
    {
        id = c.CourseId,
        title = c.Title,
        category = c.Category ?? "Web Development", // Fallback nếu null
        level = c.Level?.ToLower() ?? "beginner",   // Chuyển về chữ thường để khớp filter
        price = c.Price,
        rating = c.Rating,
        students = c.Students,
        duration = c.Duration,
        instructor = c.InstructorName ?? "CourseSphere",
        image = c.Image
    }).ToList();

    var coursesJson = JsonSerializer.Serialize(coursesData);
    }

    <div x-data="courseCatalog()" class="container mx-auto px-4 py-8">

        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">All Courses</h1>
            <p class="text-gray-500">Explore our collection of courses</p>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <input x-model="search" type="text" placeholder="Search courses..." class="w-full md:w-1/2 rounded-lg border px-4 py-2" />

            <select x-model="sortBy" class="w-48 rounded-lg border px-4 py-2">
                <option value="popular">Most Popular</option>
                <option value="rating">Highest Rated</option>
                <option value="price-low">Price: Low → High</option>
                <option value="price-high">Price: High → Low</option>
            </select>
        </div>

        <div class="flex gap-8">
            <aside class="hidden lg:block w-64">
                <div class="sticky top-20 space-y-6 rounded-xl border bg-white p-5">
                    <div>
                        <h3 class="font-semibold mb-3">Category</h3>
                        <template x-for="cat in categories" :key="cat">
                            <label class="flex items-center gap-2 mb-2 text-sm">
                                <input type="checkbox" x-model="selectedCategories" :value="cat" class="h-4 w-4 rounded border-gray-300">
                                <span x-text="cat"></span>
                            </label>
                        </template>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-3">Level</h3>
                        <template x-for="lvl in levels" :key="lvl">
                            <label class="flex items-center gap-2 mb-2 text-sm capitalize">
                                <input type="checkbox" x-model="selectedLevels" :value="lvl" class="h-4 w-4 rounded border-gray-300">
                                <span x-text="lvl"></span>
                            </label>
                        </template>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Max Price</h3>
                        <input type="range" min="0" max="500" step="10" x-model="price" class="w-full">
                        <div class="text-sm text-gray-500 mt-1">Up to $<span x-text="price"></span></div>
                    </div>
                    <button x-show="hasFilters()" x-on:click="clearFilters" class="w-full rounded-lg border py-2 text-sm hover:bg-gray-50">Clear filters</button>
                </div>
            </aside>

            <div class="flex-1">
                <p class="text-sm text-gray-500 mb-4"><span x-text="filtered.length"></span> courses found</p>

                <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    <template x-for="course in paginatedCourses()" :key="course.id">
                        <a :href="`/Course/Details/${course.id}`" class="group rounded-xl border bg-white hover:shadow-lg transition overflow-hidden">
                            <div class="aspect-video bg-gray-100 relative">
                                <img :src="course.image || 'https://placehold.co/400x250'" class="w-full h-full object-cover">
                            </div>

                            <div class="p-4 space-y-3">
                                <div class="flex gap-2">
                                    <span class="text-xs px-2 py-0.5 rounded bg-gray-100" x-text="course.category"></span>
                                    <span class="text-xs px-2 py-0.5 rounded border capitalize" x-text="course.level"></span>
                                </div>
                                <h3 class="font-semibold group-hover:text-indigo-600 line-clamp-2" x-text="course.title"></h3>
                                <div class="text-sm text-gray-500" x-text="course.instructor"></div>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <span>⭐ <span x-text="course.rating"></span></span>
                                    <span>👥 <span x-text="course.students"></span></span>
                                    <span>⏱ <span x-text="course.duration"></span></span>
                                </div>
                                <div class="font-bold text-lg">
                                    <span x-text="course.price == 0 ? 'Free' : '$' + course.price"></span>
                                </div>
                            </div>
                        </a>
                    </template>
                </div>

                <div x-show="filtered.length === 0" class="text-center py-12">
                    <p class="text-gray-400">No courses match your filters.</p>
                    <button @@click="clearFilters" class="text-primary-600 font-medium hover:underline mt-2">Clear all filters</button>
                </div>

                <div class="flex justify-center items-center gap-2 mt-8" x-show="totalPages() > 1">
                    <button x-on:click="prevPage" :disabled="page === 1" class="px-3 py-1 border rounded disabled:opacity-40">Prev</button>
                    <template x-for="p in totalPages()" :key="p">
                        <button x-on:click="page = p" :class="page === p ? 'bg-black text-white' : 'border'" class="px-3 py-1 rounded"><span x-text="p"></span></button>
                    </template>
                    <button x-on:click="nextPage" :disabled="page === totalPages()" class="px-3 py-1 border rounded disabled:opacity-40">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
function courseCatalog() {
    return {
        search: '',
        sortBy: 'popular',
        price: 500, // Tăng max price lên cho thoải mái
        page: 1,
        pageSize: 6,

        // Filter Options
        categories: ['Development', 'Web Development', 'Data Science', 'Design', 'Mobile'],
        levels: ['beginner', 'intermediate', 'advanced'],

        selectedCategories: [],
        selectedLevels: [],

        // 2. NHẬN DỮ LIỆU TỪ BACKEND TẠI ĐÂY
        courses: @Html.Raw(coursesJson),

        get filtered() {
            let list = this.courses.filter(c =>
                c.title.toLowerCase().includes(this.search.toLowerCase()) &&
                c.price <= this.price &&
                (this.selectedCategories.length === 0 || this.selectedCategories.includes(c.category)) &&
                (this.selectedLevels.length === 0 || this.selectedLevels.includes(c.level))
            )

            if (this.sortBy === 'popular') list.sort((a,b)=>b.students-a.students)
            if (this.sortBy === 'rating') list.sort((a,b)=>b.rating-a.rating)
            if (this.sortBy === 'price-low') list.sort((a,b)=>a.price-b.price)
            if (this.sortBy === 'price-high') list.sort((a,b)=>b.price-a.price)

            return list
        },

        paginatedCourses() {
            const start = (this.page - 1) * this.pageSize
            return this.filtered.slice(start, start + this.pageSize)
        },

        totalPages() {
            return Math.ceil(this.filtered.length / this.pageSize)
        },

        nextPage() {
            if (this.page < this.totalPages()) this.page++
        },

        prevPage() {
            if (this.page > 1) this.page--
        },

        hasFilters() {
            return this.selectedCategories.length || this.selectedLevels.length || this.price < 500
        },

        clearFilters() {
            this.selectedCategories = []
            this.selectedLevels = []
            this.price = 500
            this.page = 1
        }
    }
}
    </script>
