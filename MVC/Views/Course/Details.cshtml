@using Domain.Responses.Course
@using System.Text.Json
@using System.Globalization

@* ===> QUAN TRỌNG: DÙNG DTO MỚI (StudentCourseDetailResponse) <=== *@
@model StudentCourseDetailResponse

@{
    ViewData["Title"] = Model.Title;

    var courseData = new
    {
        modules = Model.Modules.Select(m => new
        {
            title = m.Title,
            lessons = m.Lessons.Select(l => new
            {
                title = l.Title,
                duration = l.Duration,
                type = l.Type
            }).ToList()
        }).ToList()
    };

    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
    var courseJson = JsonSerializer.Serialize(courseData, jsonOptions);
}

<div x-data="courseDetail()" class="bg-zinc-50 min-h-screen font-sans text-zinc-900 pb-20 relative">

    <div class="absolute top-0 left-0 w-full h-[400px] bg-gradient-to-b from-zinc-200 via-zinc-100 to-zinc-50 -z-10"></div>

    <div class="container mx-auto px-6 py-8">

        <div class="bg-white rounded-3xl shadow-xl shadow-zinc-200/60 border border-white p-8 md:p-10 relative z-10 mb-12">
            <div class="grid lg:grid-cols-3 gap-10">

                <div class="lg:col-span-2">
                    <div class="flex items-center gap-3 mb-6 text-sm font-medium">
                        <span class="text-primary-700 bg-primary-50 px-3 py-1 rounded-full border border-primary-100">
                            @Model.Category
                        </span>
                        <i class="fas fa-chevron-right text-[10px] text-zinc-400"></i>
                        <span class="text-zinc-500 capitalize">@Model.Level</span>
                    </div>

                    <h1 class="text-4xl md:text-5xl font-black tracking-tight text-zinc-900 mb-6 leading-tight">
                        @Model.Title
                    </h1>

                    <p class="text-lg text-zinc-600 mb-8 leading-relaxed max-w-2xl">
                        @Model.Description
                    </p>

                    <div class="flex flex-wrap items-center gap-8 border-t border-zinc-100 pt-6">
                        <div class="flex items-center gap-3">
                            <div class="h-12 w-12 rounded-full bg-zinc-900 text-white flex items-center justify-center font-bold text-lg border-4 border-zinc-50 shadow-sm">
                                @(Model.InstructorName?.Substring(0, 1).ToUpper() ?? "I")
                            </div>
                            <div>
                                <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-wider">Created by</p>
                                <p class="text-sm font-bold text-zinc-900">@Model.InstructorName</p>
                            </div>
                        </div>

                        <div class="flex flex-col">
                            <div class="flex items-center gap-1 text-amber-500">
                                <span class="font-black text-xl text-zinc-900">@Model.Rating</span>
                                <div class="text-xs flex"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div>
                            </div>
                            <p class="text-xs text-zinc-500 font-medium">@Model.Students ratings</p>
                        </div>
                    </div>
                </div>

                <div class="hidden lg:block"></div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-12 relative">

            <div class="lg:col-span-2 space-y-10">

                <div class="bg-white border border-zinc-200 rounded-2xl p-8 shadow-sm">
                    <h3 class="text-xl font-bold text-zinc-900 mb-6">What you'll learn</h3>
                    <ul class="grid sm:grid-cols-2 gap-y-4 gap-x-8">
                        <li class="flex gap-3 items-start text-sm text-zinc-600"><i class="fas fa-check text-emerald-500 mt-1"></i> <span>Build robust apps</span></li>
                        <li class="flex gap-3 items-start text-sm text-zinc-600"><i class="fas fa-check text-emerald-500 mt-1"></i> <span>Master tools</span></li>
                    </ul>
                </div>

                <div class="bg-white border border-zinc-200 rounded-3xl p-8 shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-zinc-900">Course Content</h3>
                        <div class="text-xs font-medium text-zinc-400 bg-zinc-100 px-3 py-1 rounded-full">
                            <span x-text="modules.length"></span> sections • <span x-text="modules.reduce((acc, m) => acc + m.lessons.length, 0)"></span> lectures
                        </div>
                    </div>

                    <div class="border border-zinc-200 rounded-xl overflow-hidden divide-y divide-zinc-100 bg-zinc-50/30">
                        <template x-for="(module, index) in modules" :key="index">
                            <div x-data="{ open: index === 0 }">
                                <button @@click="open = !open" class="w-full px-6 py-4 flex justify-between items-center bg-white hover:bg-zinc-50 transition-colors text-left group">
                                    <div class="flex items-center gap-4">
                                        <i class="fas fa-chevron-down text-xs text-zinc-400 transition-transform duration-300 group-hover:text-zinc-900" :class="open ? 'rotate-180' : ''"></i>
                                        <span class="font-bold text-zinc-800 text-sm" x-text="module.title"></span>
                                    </div>
                                    <span class="text-xs font-medium text-zinc-400" x-text="module.lessons.length + ' lessons'"></span>
                                </button>
                                <div x-show="open" x-collapse>
                                    <div class="px-2 py-2">
                                        <template x-for="lesson in module.lessons">
                                            <div class="flex justify-between items-center px-4 py-3 rounded-lg hover:bg-white hover:shadow-sm transition-all cursor-default mx-2 border border-transparent hover:border-zinc-100">
                                                <div class="flex items-center gap-3">
                                                    <i class="fas text-xs w-5 text-center text-zinc-400"
                                                       :class="{'fa-play': lesson.type === 'Video', 'fa-book': lesson.type === 'Reading', 'fa-question': lesson.type === 'Quiz'}"></i>
                                                    <span class="text-sm text-zinc-600 font-medium" x-text="lesson.title"></span>
                                                </div>
                                                <span class="text-xs text-zinc-400" x-text="lesson.duration"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 relative">
                <div class="sticky top-24 lg:-mt-[450px] z-20">
                    <div class="bg-white rounded-3xl shadow-xl shadow-zinc-300/40 border border-zinc-200 overflow-hidden">

                        <div class="aspect-video bg-zinc-100 relative group cursor-pointer border-b border-zinc-100">
                            <img src="@(string.IsNullOrEmpty(Model.Image) ? "https://placehold.co/600x400?text=No+Image" : Model.Image)" class="w-full h-full object-cover transition-opacity hover:opacity-90">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white/90 backdrop-blur rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                    <i class="fas fa-play text-zinc-900 text-xl ml-1"></i>
                                </div>
                            </div>
                        </div>

                        <div class="p-8">
                            <div class="mb-8">
                                @if (Model.Price == 0) {
                                <span class="block text-4xl font-black text-zinc-900 mb-1">Free</span>
                                } else {
                                <div class="flex items-baseline gap-3 mb-1">
                                    <span class="text-4xl font-black text-zinc-900">@Model.Price.ToString("C", new CultureInfo("en-US"))</span>
                                    <span class="text-lg text-zinc-400 line-through decoration-1">$199.99</span>
                                </div>
                                }
                            </div>

                            <div class="space-y-4">
                                @if (Model.Price == 0) {
                                <form asp-controller="Enrollment" asp-action="FreeEnroll" method="post">
                                    <input type="hidden" name="courseId" value="@Model.CourseId" />
                                    <button type="submit" class="w-full py-4 bg-zinc-900 hover:bg-black text-white rounded-2xl font-bold text-lg shadow-lg hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                                        <span>Enroll Now</span> <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                                } else {
                                <form asp-controller="Payment" asp-action="Checkout" method="post">
                                    <input type="hidden" name="courseId" value="@Model.CourseId" />
                                    <button type="submit" class="w-full py-4 bg-primary-600 hover:bg-primary-700 text-white rounded-2xl font-bold text-lg shadow-lg transition-all">
                                        Buy Now
                                    </button>
                                </form>
                                }
                            </div>

                            <p class="text-center text-[10px] text-zinc-400 font-medium mt-6">30-Day Money-Back Guarantee</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function courseDetail() {
        return { ... @Html.Raw(courseJson) }
    }
</script>